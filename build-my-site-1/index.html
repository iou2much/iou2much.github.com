<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="AI rules.."><title>【debug.life构建手记】 ( 一 ) 基础设施搭建 | Coders' Lab</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.1"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【debug.life构建手记】 ( 一 ) 基础设施搭建</h1><a id="logo" href="/.">Coders' Lab</a><p class="description">focus on AI</p></div><div id="nav-menu"><a href="/"><i class="fa icon-home"> 首页</i></a><a href="/ai_notes_html/"><i class="fa icon-tree"> AI笔记</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【debug.life构建手记】 ( 一 ) 基础设施搭建</h1><div class="post-meta">Jan 16, 2016<span> | </span><span class="category"><a href="/categories/Tools/">Tools</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#购买阿里云ECS"><span class="toc-number">1.</span> <span class="toc-text">购买阿里云ECS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#申请域名及配置解析到阿里云主机"><span class="toc-number">2.</span> <span class="toc-text">申请域名及配置解析到阿里云主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartSSL申请SSL证书"><span class="toc-number">3.</span> <span class="toc-text">StartSSL申请SSL证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Openresty"><span class="toc-number">4.</span> <span class="toc-text">安装Openresty</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编译安装OpenResty"><span class="toc-number">4.1.</span> <span class="toc-text">编译安装OpenResty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Nginx"><span class="toc-number">4.2.</span> <span class="toc-text">配置Nginx:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动nginx"><span class="toc-number">4.3.</span> <span class="toc-text">启动nginx:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol></div></div><div class="post-content"><p>本文是本站搭建记录系列的第一篇，会尽量详细地介绍如何从零开始搭建出这个网站。</p>
<p>虽然这些并没有太多的技术含量，但是我想对有意向搭建博客的同学有一点帮助，让更多技术宅能动起指头写些什么，这样也就能结识更多同学，和志同道合的同学交流多一点。</p>
<p>本站不仅仅是想要做成一个技术博客，而想更进一步让读者能在这个网站上把学到的技术知识动手操作练习。所以我特地在阿里云租用了一个ECS，能以较灵活和稳定地提供服务。以下是本站的搭建过程：</p>
<h3 id="购买阿里云ECS"><a href="#购买阿里云ECS" class="headerlink" title="购买阿里云ECS"></a>购买阿里云ECS</h3><ul>
<li><p>首先需要有个阿里的账号，直接用淘宝号登录 <a href="http://www.aliyun.com/" target="_blank" rel="external">http://www.aliyun.com/</a> 即可；</p>
</li>
<li><p>然后进入管理台，选择左菜单栏中的ECS，(ECS是云主机，有操作系统级的控制权；而ACE是云应用，只能部署应用上去，不够灵活)</p>
</li>
</ul>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ali%20yun%201.png" alt="进入ECS"></p>
<ul>
<li>接着进到这个页面，我随便选了一个地区的服务器（国内的几个点应该都差别不大）：</li>
</ul>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ali%20yun%202.png" alt="进入购买页"></p>
<ul>
<li>接着就到了具体选择机器配置的页面了，我这里选了一个最低配，有需要以后可以再扩容：</li>
</ul>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ali%20yun%203.png" alt="配置虚拟硬件"></p>
<ul>
<li>购买成功后便可以在机器列表中看到新建的实例了，可以从我抹掉的那个位置看到IP，像操作普通服务器那样ssh连接上去便可以进行管理了：</li>
</ul>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ali%20yun%204.png" alt="查看ECS"></p>
<h3 id="申请域名及配置解析到阿里云主机"><a href="#申请域名及配置解析到阿里云主机" class="headerlink" title="申请域名及配置解析到阿里云主机"></a>申请域名及配置解析到阿里云主机</h3><p>为了尽量避免国内域名要备案的蛋疼遭遇，我在Godaddy(还因为它支持支付宝~）上申请了域名 debug.life 。 注册及购买过程网上很多，不再赘述。</p>
<p>这里主要说一下Godday的域名解析到阿里的ECS。</p>
<ul>
<li>在Godaddy的域名管理页面，点击Manage DNS<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/domain.png" alt="设置DNS"><br>这里是要把Godaddy的DNS配置为阿里的：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/domain2.png" alt="点击Manage"></li>
<li>然后回到阿里云的控制台，进到“云解析”页面，添加debug.life域名到阿里的平台：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/domain3.png" alt="添加域名"></li>
<li>添加完后，会如上图那样，在列表中出现新添加的域名，接着要点击那个域名链接，进到管理它的页面，在“解析设置”的页面中，添加解析：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/domain4.png" alt="添加解析二级域名"><br>记录类型要选 <code>A</code> 类解析，主机记录可以看图中的解释，最重要的是在“记录值”中填上阿里ECS主机的外网IP。</li>
</ul>
<h3 id="StartSSL申请SSL证书"><a href="#StartSSL申请SSL证书" class="headerlink" title="StartSSL申请SSL证书"></a>StartSSL申请SSL证书</h3><p>现在移动端的劫持很常见，所以打算一开始就把ssl配好算了，在知乎搜了一下免费的SSL证书厂商，见挺多人推荐 <a href="https://www.startssl.com/" target="_blank" rel="external">https://www.startssl.com/</a> 的，便申请了一个，过程还算顺利。</p>
<p>账号注册过程没啥特别，也不赘述。主要说一下证书生成过程。</p>
<ul>
<li>进入账号的管制台，选择”Authenticate”</li>
</ul>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl0.png" alt="登录后，进入申请页面"></p>
<ul>
<li><p>进入到下一步后，有四个选择，只有右下角那个是免费的：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl1.png" alt="选择免费证书"></p>
</li>
<li><p>再下一步，可以看到这个页面有三个页签，要先进第三个验证你要申请SSL的域名：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl2.png" alt="验证域名"></p>
</li>
<li><p>在这里填好域名后，startSSL会检测出你注册域名时的管理员email，这个检测过程可能有点慢，需要耐心等待，当检测成功后，你的域名注册邮箱就会出现在这个列表里，选择那个邮箱，点击”Send Verification Code”，StartSSL会把验证码发过去，之后登录那个邮箱取得验证码填回这个页面提交：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl3.png" alt="域名管理员邮箱收取验证码"></p>
</li>
<li><p>经过上一步，StartSSL已经认证过了你的域名，接着进入”Certificates Wizard”这个页签，作以下操作：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl4.png" alt="申请二级域名证书"></p>
</li>
<li><p>进到这个页面，填上需要注册证书的二级域名，并要生成一个key，要选择”Generated by PKI system”，输入一个密码（请记住这个密码，之后重启Nginx需要用到），并提交：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl5.png" alt="生成key文件"></p>
</li>
<li><p>点击了上一步的submit后，会出现一个私钥的下载浮层，先点左边的Download,再要点右边的submit：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl6.png" alt="下载key文件，并提交"></p>
</li>
<li><p>到了这步，整个申请流程已经结束，可以在这里的”here”链接下载crt包：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl7.png" alt="下载crt压缩包"></p>
</li>
<li><p>又或者在”Tool Box”页签下，能看到所有的证书列表，从下图的红圈位置的链接中，也可以下载已经申请过的证书：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl8.png" alt="查看已申请证书"></p>
</li>
<li><p>下载回来的证书是一个zip包，解压出来有多个crt的版本，从文件名可以看到，StartSSL已经给我们定制好适用于Apache或者是Nginx或IIS的crt文件，非常贴心：<br><img src="http://7xpy3x.com1.z0.glb.clouddn.com/ssl9.png" alt="得到的证书"></p>
</li>
</ul>
<p>最后，我得到的是一个ssl.key文件和一个zip包，先把这两个文件传到服务器上。</p>
<h3 id="安装Openresty"><a href="#安装Openresty" class="headerlink" title="安装Openresty"></a>安装Openresty</h3><p><a href="https://openresty.org/cn/" target="_blank" rel="external">OpenResty</a> 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<h4 id="编译安装OpenResty"><a href="#编译安装OpenResty" class="headerlink" title="编译安装OpenResty"></a>编译安装OpenResty</h4><pre><code class="sh">cd /opt
wget https://openresty.org/download/ngx_openresty-1.9.7.1.tar.gz
tar xzvf ngx_openresty-1.9.7.1.tar.gz
cd ngx_openresty-1.9.7.1/
./configure --prefix=/usr/local/services/openresty
make
make install
</code></pre>
<h4 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx:"></a>配置Nginx:</h4><pre><code class="sh">vim /usr/local/services/openresty/nginx/conf/conf.d/debug.life.conf
</code></pre>
<pre><code class="json">
#由于以后有部分服务需要使用Websocket，需要配置这段
map $http_upgrade $connection_upgrade {
    default upgrade;
    &#39;&#39;      close;
}

#把 HTTP请求转到HTTPS
server {
    listen 80;
    server_name  www.debug.life debug.life my.debug.life;
    rewrite ^(.*)$  https://$host$1 permanent;
}

server {
    listen 443 ssl;
    ssl on;

    server_name  debug.life my.debug.life;

    #指定证书文件，这里的key和crt文件，就是前面从StartSSL申请到的。
    ssl_certificate /usr/local/services/openresty/nginx/ssl/my.debug.life.crt;
    ssl_certificate_key /usr/local/services/openresty/nginx/ssl/my.debug.life.key;

    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  5m;

    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers   on;

    root   html;
    index  index.html index.htm;

    error_page   404 400 500 502 503 504 = /error.html;
    location = /error.html {
        root   /home/chibs/res;
    }


    location /notebook {
        rewrite ^/(.*)    https://notebook.debug.life/  redirect;
    }

    location / {
        root /home/chibs/debug.life;
    }
    location /res {
        root /home/chibs/;
    }
}

server {
    listen 443 ssl;
    ssl on;

    server_name  www.debug.life;

    ssl_certificate /usr/local/services/openresty/nginx/ssl/www.debug.life.crt;
    ssl_certificate_key /usr/local/services/openresty/nginx/ssl/www.debug.life.key;

    root   html;
    index  index.html index.htm;
    location /notebook {
        rewrite ^/(.*)    https://notebook.debug.life/  redirect;
    }

    location / {
        rewrite ^(.*)$  https://debug.life$1 permanent;
        #root /home/chibs/debug.life;
    }
}
</code></pre>
<h4 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx:"></a>启动nginx:</h4><pre><code class="sh">/usr/local/services/openresty/nginx/sbin/nginx
</code></pre>
<p>启动时需要输入刚刚在StartSLL生成私钥时的密码：</p>
<p><img src="http://7xpy3x.com1.z0.glb.clouddn.com/nginx.png" alt="启动nginx"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>至此，我已经在阿里云上搭建好一个由Openresty运行着的HTTPS站点；之后，我会使用Hexo搭建出你现在所看到的博客系统。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.1" async></script><a data-url="http://ai-code.tech/build-my-site-1/" data-id="ciy9iru2w0006fgttnyss6f2o" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Openresty/">Openresty</a><a href="/tags/Aliyun/">Aliyun</a><a href="/tags/https/">https</a><a href="/tags/Nginx/">Nginx</a></div><div class="post-nav"><a href="/build-micro-service-with-java/" class="pre">【译文】使用Java构建微服务</a><a href="/Docker-difference-between-container-n-vms/" class="next">【译文】Docker:容器与虚拟机的差异</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Translation/">Translation</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Openresty/" style="font-size: 15px;">Openresty</a> <a href="/tags/Aliyun/" style="font-size: 15px;">Aliyun</a> <a href="/tags/https/" style="font-size: 15px;">https</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Mac-OS-X/" style="font-size: 15px;">Mac OS X</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/build-with-docker/">用Docker容器编译软件</a></li><li class="post-list-item"><a class="post-list-link" href="/startup-micro-service-with-ruby/">【译文】使用Ruby on Rails和Docker开始微服务之旅</a></li><li class="post-list-item"><a class="post-list-link" href="/what-would-docker-bring-to-your-team/">【译文】Docker会给你的开发团队带来什么变化？</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-use-docker-to-build-mapr-cluster/">【译文】如何使用Docker创建开箱即用的MapR集群</a></li><li class="post-list-item"><a class="post-list-link" href="/opensource-docker-n-java-projects/">【译文】Java项目与Docker</a></li><li class="post-list-item"><a class="post-list-link" href="/build-my-site-3/">【debug.life构建手记】 ( 三 ) Docker化本站</a></li><li class="post-list-item"><a class="post-list-link" href="/build-my-site-2/">【debug.life构建手记】 ( 二 ) Hexo静态博客搭建及配置</a></li><li class="post-list-item"><a class="post-list-link" href="/build-micro-service-with-java/">【译文】使用Java构建微服务</a></li><li class="post-list-item"><a class="post-list-link" href="/build-my-site-1/">【debug.life构建手记】 ( 一 ) 基础设施搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/Docker-difference-between-container-n-vms/">【译文】Docker:容器与虚拟机的差异</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://notebook.debug.life/tree" title="Notebook" target="_blank">Notebook</a><ul></ul><a href="http://jupyter.debug.life/" title="Jupyter" target="_blank">Jupyter</a><ul></ul><a href="http://www.lancezhange.com/" title="Hexo大牛" target="_blank">Hexo大牛</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Coders' Lab.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.1" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.1"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?4492c5298a95d05e162aa9bd5f8b145b";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.1"></script></div></body></html>